# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  # each new commit to a PR runs this workflow
  # so we need to avoid a long running older one from overwriting the "pr-<number>-latest"
  group: "${{ github.workflow }} @ ${{ github.ref_name }}"
  cancel-in-progress: true

permissions:
  contents: read

env:
  NPM_CONFIG_FUND: "false"

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - &checkout
        name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          show-progress: false

      - name: Check if we actually made changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: .github/file-filters.yml

  warm-up-cache:
    name: Warm up the cache
    runs-on: ubuntu-latest
    permissions:
      packages: read
    steps:
      - *checkout

      - &install_pnpm
        name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - &install_node
        name: Set up node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: package.json
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
          registry-url: https://npm.pkg.github.com

      - name: Download dependencies
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pnpm install --frozen-lockfile

  npm-build:
    name: Build the code
    runs-on: ubuntu-latest
    needs:
      - warm-up-cache
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          show-progress: false
          token: ${{ secrets.TOKEN_TO_TRIGGER_SUBSEQUENT_WORKFLOWS }}

      - *install_pnpm

      - *install_node

      - &download_deps_from_cache
        name: Download dependencies from cache
        shell: bash
        run: |
          pnpm install --frozen-lockfile --offline

      - name: Run build
        shell: bash
        run: |
          pnpm run build

      - name: Compare the expected and actual dist/ directories
        id: diff
        env:
          # for gh-cli
          GH_TOKEN: ${{ secrets.TOKEN_TO_TRIGGER_SUBSEQUENT_WORKFLOWS }}
        run: |
          if [ "$(git diff --ignore-space-at-eol dist/ | wc -l)" -gt "0" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            BRANCH="dist-updated-${PR_NUMBER}"

            echo "Detected uncommitted changes after build. Checking in changes on branch: ${BRANCH}"
            git checkout -b ${BRANCH}

            echo "Please see the artifacts of this build for the changes"
            git diff > diff.txt

            echo "Creating commit with changes"
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            echo "Committing changes in dist/"
            git add dist/
            git commit --message "chore: commiting changes in dist/. See #${PR_NUMBER}"

            # Remove GitHub's merging the tip of dist-updated branch into main's commit
            # it's not needed as we require a branch to up-to-date with main
            git rebase origin/main --autosquash

            echo "Pushing branch"
            git push --force --set-upstream origin HEAD

            echo "Creating PR"
            gh pr create --base main --head ${BRANCH} --title "chore(deps): rebuilding because files in dist have updated" --fill

            exit 1
          fi

      # If dist/ was different than expected, upload the expected version as an artifact
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ failure() && steps.diff.conclusion == 'failure' }}
        with:
          name: dist
          path: |
            dist/
            diff.txt

  npm-lint:
    name: Lint the code
    runs-on: ubuntu-latest
    permissions:
      checks: write
    needs:
      - changes
      - warm-up-cache
    steps:
      - *checkout

      - *install_pnpm

      - *install_node

      - *download_deps_from_cache

      - name: Run lint
        shell: bash
        run: |
          pnpm run lint --format=json --output-file reports/lint-report.json || true

          # hack to print results in the console
          node --print "require('./node_modules/eslint/lib/cli-engine/formatters/stylish.js')(require('./reports/lint-report.json'))"

      - name: Annotate Code Linting Results
        uses: ataylorme/eslint-annotate-action@d57a1193d4c59cbfbf3f86c271f42612f9dbd9e9 # 3.0.0
        with:
          fail-on-error: true
          fail-on-warning: true
          markdown-report-on-step-summary: true
          only-pr-files: false
          report-json: reports/lint-report.json

  npm-test:
    name: Test the code
    runs-on: ubuntu-latest
    needs:
      - warm-up-cache
    permissions:
      checks: write
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - *checkout

      - *install_pnpm

      - *install_node

      - *download_deps_from_cache

      - name: Run tests
        shell: bash
        id: tests
        run: |
          pnpm run test --reporter=default --reporter=github-actions --reporter=junit --coverage.reporter=text --coverage.reporter=lcovonly
        continue-on-error: true

      - name: Upload test results
        uses: EnricoMi/publish-unit-test-result-action@27d65e188ec43221b20d26de30f4892fad91df2f # v2.22.0
        with:
          check_name: Test results
          github_token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            reports/results.xml

      - name: Upload coverage results (to Codecov.io)
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          disable_search: true
          disable_telem: true
          fail_ci_if_error: true
          files: reports/lcov.info
          plugins: ""
          report_type: "coverage"
          use_oidc: true

      - name: Upload test results (to Codecov.io)
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          disable_search: true
          disable_telem: true
          fail_ci_if_error: true
          files: reports/results.xml
          plugins: ""
          report_type: "test_results"
          use_oidc: true

      - name: Fail if tests failed
        shell: bash
        if: |
          steps.tests.outcome != 'success'
        run: |
          # the test reporter we use (or any for that matter)
          # all show a report. But we cannot depend on that report because
          # we don't know which subsection it belongs in GitHub
          # so we explicitly fail this one
          # which will fail All Done
          exit 1

  npm-test-windows:
    name: Test the code on Windows
    runs-on: windows-latest
    permissions:
      packages: read
    steps:
      - *checkout

      - *install_pnpm

      - *install_node

      - name: Download dependencies
        shell: pwsh
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pnpm install --frozen-lockfile

      - name: Run tests
        shell: pwsh
        run: |
          pnpm run test --reporter=default --reporter=github-actions --reporter=junit --coverage.reporter=text --coverage.reporter=lcovonly

  npm-dependencies:
    name: Validate dependencies
    runs-on: ubuntu-latest
    needs:
      - warm-up-cache
    steps:
      - *checkout

      - *install_pnpm

      - *install_node

      - *download_deps_from_cache

      - name: Check dependencies
        shell: bash
        run: |
          pnpm run deps:ci

  all-done:
    name: All done
    # this is the job that should be marked as required on GitHub. It's the only one that'll reliably trigger
    # when any upstream fails: success
    # when all upstream skips: pass
    # when all upstream success: success
    # combination of upstream skip and success: success
    runs-on: ubuntu-latest
    needs:
      - warm-up-cache
      - npm-build
      - npm-dependencies
      - npm-lint
      - npm-test
      - npm-test-windows
    if: |
      always()
    steps:
      - name: Fail!
        shell: bash
        if: |
          contains(needs.*.result, 'failure') ||
          contains(needs.*.result, 'cancelled')
        run: |
          echo "One / more upstream failed or was cancelled. Failing job..."

          exit 1

      - name: Success!
        shell: bash
        run: |
          echo "Great success!"
